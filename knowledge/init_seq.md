在 TCP 连接中，起始序号（Initial Sequence Number，ISN）的选择是一个非常重要的过程。正确选择起始序号能够确保数据传输的可靠性、避免序号重叠，并且提高系统的安全性。

### 1. 为什么起始序号不从0开始？

在早期的 TCP 实现中，起始序号可能从 0 开始，但这并不是一个理想的选择。主要原因有两个：

- **避免序号重叠：** 如果一个连接的起始序号从 0 开始，那么如果网络中存在多个连接，这些连接的序号可能会重叠。例如，如果两个连接的起始序号都为 0，那么后续的序号（如 1, 2, 3…）就会互相重叠，可能导致连接间的混淆和数据丢失，尤其是当某个连接上的数据包被延迟或重新传输时。为了避免这种情况，TCP 选择了一个更为复杂的机制来生成起始序号。
  
- **提高安全性：** 如果每次连接的起始序号都从固定的值（如 0）开始，恶意攻击者可以通过猜测序号来进行攻击（例如，TCP 劫持）。因此，起始序号的选择需要具有一定的随机性，以增加攻击的难度。

### 2. 为什么必须避免新旧连接之间的序号重叠？

当在同一对套接字（即相同的源 IP 和目的 IP，以及源端口和目的端口）之间建立多个连接时，如果不同的连接使用相同的起始序号或序号相差很小，就会存在潜在的序号重叠风险。例如，新的连接的序号可能会与旧连接中的某个未确认的数据包序号重叠，导致重传的数据包被错误地当作新连接的包处理。

TCP 序号是 32 位的，理论上有 \($2^{32}$ = 4,294,967,296\) 个不同的序号。当序号到达最大值（即 \($2^{32}$ - 1\)）时，会发生回绕（wraparound）。如果新旧连接的起始序号相差较小，而旧连接上的数据包还没有完全确认或被丢弃，那么这些数据包可能在网络中“漂移”一段时间，并且一旦回绕，旧连接的报文段可能会误认为是新连接的报文段，从而导致错误的解码或数据丢失。

因此，为了避免这种重叠，必须确保每个连接的起始序号在时间上是单调递增的，并且不能与旧连接的序号重叠。

### 3. TCP 起始序号的选择机制

为了避免上述问题，TCP 采用了基于时钟的起始序号选取算法。具体来说，TCP 使用系统的时钟（通常是一个高精度的计数器）来生成起始序号：

- **计数器：** 每个主机上有一个计数器，通常是 32 位的二进制计数器。计数器每隔一个固定的时间间隔（比如 4 微秒）增加 1。这意味着系统时间的流逝会影响起始序号的选择。

- **起始序号的生成：** 在新建连接时，TCP 会选择计数器的最低 32 位作为该连接的起始序号。这确保了连接的起始序号随着时间单调递增，从而减少了序号冲突的可能性。

- **避免序号回绕：** 因为每个连接的序号空间有 32 位（即最大为 \($2^{32}$ - 1\)），而每个连接的生命周期通常远小于序号回绕的周期，所以即使存在回绕，序号空间也能在较长时间内保持独立，避免与旧连接的序号重叠。TCP 设计时将回绕的周期设定得很长，通常远大于网络中数据包的传输时延。因此，回绕通常不会影响实际的数据传输。

### 4. 选择较小的时间间隔（AT）

在时钟计数器增加的过程中，时间间隔（AT）决定了计数器的增长速度。AT 一般选择为较小的值，例如 4 微秒。这是因为：

- **序号增长速度要慢于发送序号的增长速度：** 为了确保起始序号的递增速度不会超过发送的序号，AT 被选择为一个相对较小的时间间隔。这样可以保证即使在高频率的连接建立过程中，序号增长仍然具有足够的差异性，避免重叠。

- **增加起始序号的间隔：** 如果 AT 时间间隔过长，起始序号可能会变化得太慢，导致不同连接的序号间隔过小，增加了重叠的可能性。因此选择较小的时间间隔可以更好地避免这种情况。

### 5. 如何避免序号重叠

为了避免新旧连接之间的序号重叠，TCP 采用了如下措施：

- **确保起始序号的递增：** 通过将起始序号与系统时钟挂钩，TCP 确保了每个连接的起始序号随时间单调递增。
  
- **使用较长的序号空间：** 通过使用 32 位的序号空间，TCP 确保了在大规模连接和长时间运行的情况下，即使序号回绕，也不会导致重叠。

- **避免使用固定序号：** 不使用固定的起始序号（如 0 或其他常量），以减少序号冲突的可能性。

### 总结

TCP 的起始序号选取算法通过基于时钟的计数器来避免序号冲突和重叠。起始序号不是从 0 开始，而是通过系统时钟生成，这保证了序号随时间单调递增，避免了新旧连接的序号重叠问题。通过采用 32 位序号和较小的时间间隔，TCP 确保了序号增长的速度不会超过数据包的传输速度，从而避免了潜在的冲突和误判。